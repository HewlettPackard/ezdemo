---
######################################################################################################
# VMWARE DEPLOYMENT 
######################################################################################################

#######################
# Controller Deployment
#######################

- hosts: localhost
  vars:
    controller_ips: "{{ (groups['controller'] | list) | default([])  }}"
    gateway_ips: "{{ (groups['gateway'] | list) | default([])  }}"
    picasso_ips: "{{ (groups['picasso'] | list) | default([])  }}"
    k8s_ips: "{{ (groups['k8s'] | list) | default([])  }}"
    mapr_ips: "{{ (groups['mapr'] | list) | default([]) }}"

  gather_facts: no
  tasks:

  - name: Create a VM folder on given datacenter
    community.vmware.vcenter_folder:
      hostname: "{{ vcenter_server }}"
      username: "{{ vcenter_user }}"
      password: "{{ vcenter_pass }}"
      validate_certs: no
      datacenter_name: "{{ datacenter_name }}"
      folder_name: "{{vcenter_folder}}"
      folder_type: vm
      state: present
    register: vm_folder_creation_result
    delegate_to: localhost

  - name: Clone template {{ template_name }} to the Controller
    vmware_guest:
      hostname: "{{ vcenter_server }}"
      username: "{{ vcenter_user }}"
      password: "{{ vcenter_pass }}"
      validate_certs: no
      name: "{{ item }}-ECP-CONTROLLER-{{ vm_prefix }}{{ item.split('.')[-1][-3:] }}"
      template: "{{ template_name }}"
      datacenter: "{{ datacenter_name }}"
      folder: "{{vcenter_folder}}"
      cluster: "{{ cluster_name }}"
      datastore: "{{ vcenter_datastore }}"
      hardware:
        memory_mb: "{{ vm_controller_memory }}"
        num_cpus: "{{ vm_controller_cpu_cores }}"
      networks:
      - name: "{{ vcenter_vswitch }}"
        ip: "{{ item }}"
        netmask: "{{ vm_network | ansible.utils.ipaddr('netmask') }}"
        gateway: "{{ vm_gateway }}"
        type: static
        dns_servers: "{{ vm_dns }}"
      disk:
        - autoselect_datastore: no
          datastore: "{{ vcenter_datastore }}"
          size_gb: 400
          type: thin
        - autoselect_datastore: no
          datastore: "{{ vcenter_datastore }}"
          size_gb: "{{ vm_controller_disk }}"
          type: thin
      customization:
        hostname: "{{ host_prefix }}{{ item.split('.')[-1][-3:] }}"
        domain: "{{ vm_domain }}"
        dns_servers: "{{ vm_dns }}"
      state: poweredon
      wait_for_ip_address: no
    delegate_to: localhost
    with_items: "{{ controller_ips }}"

#######################
# GATEWAY Deployment
#######################

  - name: Clone template {{ template_name }} to the Gateway
    vmware_guest:
      hostname: "{{ vcenter_server }}"
      username: "{{ vcenter_user }}"
      password: "{{ vcenter_pass }}"
      validate_certs: no
      name: "{{ item }}-ECP-GATEWAY-{{ vm_prefix }}{{ item.split('.')[-1][-3:] }}"
      template: "{{ template_name }}"
      datacenter: "{{ datacenter_name }}"
      folder: "{{vcenter_folder}}"
      cluster: "{{ cluster_name }}"
      datastore: "{{ vcenter_datastore }}"
      hardware:
        memory_mb: "{{ vm_gateway_memory }}"
        num_cpus: "{{ vm_gateway_cpu_cores }}"
      networks:
      - name: "{{ vcenter_vswitch }}"
        ip: "{{ item }}"
        netmask: "{{ vm_network | ansible.utils.ipaddr('netmask') }}"
        gateway: "{{ vm_gateway }}"
        type: static
        dns_servers: "{{ vm_dns }}"
      disk:
        - autoselect_datastore: no
          datastore: "{{ vcenter_datastore }}"
          size_gb: 400
          type: thin
      customization:
        hostname: "{{ host_prefix }}{{ item.split('.')[-1][-3:] }}"
        domain: "{{ vm_domain }}"
        dns_servers: "{{ vm_dns }}"
      state: poweredon
      wait_for_ip_address: no
    delegate_to: localhost
    with_items: "{{ gateway_ips }}"

#######################
# PICASSO Deployment
#######################

  - name: Clone template {{ template_name }} to the PICASSO
    vmware_guest:
      hostname: "{{ vcenter_server }}"
      username: "{{ vcenter_user }}"
      password: "{{ vcenter_pass }}"
      validate_certs: no
      name: "{{ item }}-ECP-K8S-PICASSO-{{ vm_prefix }}{{ item.split('.')[-1][-3:] }}"
      template: "{{ template_name }}"
      datacenter: "{{ datacenter_name }}"
      folder: "{{vcenter_folder}}"
      cluster: "{{ cluster_name }}"
      datastore: "{{ vcenter_datastore }}"
      hardware:
        memory_mb: "{{ vm_picasso_memory }}"
        num_cpus: "{{ vm_picasso_cpu_cores }}"
      networks:
      - name: "{{ vcenter_vswitch }}"
        ip: "{{ item }}"
        netmask: "{{ vm_network | ansible.utils.ipaddr('netmask') }}"
        gateway: "{{ vm_gateway }}"
        type: static
        dns_servers: "{{ vm_dns }}"
      disk:
        - autoselect_datastore: no
          datastore: "{{ vcenter_datastore }}"
          size_gb: 400
          type: thin
        - autoselect_datastore: no
          datastore: "{{ vcenter_datastore }}"
          size_gb: "{{ vm_picasso_disk }}"
          type: thin
        - autoselect_datastore: no
          datastore: "{{ vcenter_datastore }}"
          size_gb: "{{ vm_picasso_disk }}"
          type: thin
      customization:
        hostname: "{{ host_prefix }}{{ item.split('.')[-1][-3:] }}"
        domain: "{{ vm_domain }}"
        dns_servers: "{{ vm_dns }}"
      state: poweredon
      wait_for_ip_address: no
    delegate_to: localhost
    with_items: "{{ picasso_ips }}"

#######################
# K8S Deployment
#######################

  - name: Clone template {{ template_name }} to the k8s
    vmware_guest:
      hostname: "{{ vcenter_server }}"
      username: "{{ vcenter_user }}"
      password: "{{ vcenter_pass }}"
      validate_certs: no
      name: "{{ item }}-ECP-K8S-{{ vm_prefix }}{{ item.split('.')[-1][-3:] }}"
      template: "{{ template_name }}"
      datacenter: "{{ datacenter_name }}"
      folder: "{{vcenter_folder}}"
      cluster: "{{ cluster_name }}"
      datastore: "{{ vcenter_datastore }}"
      hardware:
        memory_mb: "{{ vm_k8s_memory }}"
        num_cpus: "{{ vm_k8s_cpu_cores }}"
      networks:
      - name: "{{ vcenter_vswitch }}"
        ip: "{{ item }}"
        netmask: "{{ vm_network | ansible.utils.ipaddr('netmask') }}"
        gateway: "{{ vm_gateway }}"
        type: static
        dns_servers: "{{ vm_dns }}"
      disk:
        - autoselect_datastore: no
          datastore: "{{ vcenter_datastore }}"
          size_gb: 400
          type: thin
        - autoselect_datastore: no
          datastore: "{{ vcenter_datastore }}"
          size_gb: "{{ vm_k8s_disk }}"
          type: thin
        - autoselect_datastore: no
          datastore: "{{ vcenter_datastore }}"
          size_gb: "{{ vm_k8s_disk }}"
          type: thin
      customization:
        hostname: "{{ host_prefix }}{{ item.split('.')[-1][-3:] }}"
        domain: "{{ vm_domain }}"
        dns_servers: "{{ vm_dns }}"
      state: poweredon
      wait_for_ip_address: no
    delegate_to: localhost
    with_items: "{{ k8s_ips }}"

#######################
# Standalone Data Fabric Deployment
#######################

  - name: Clone template {{ mapr_template_name }} to the mapr
    vmware_guest:
      hostname: "{{ vcenter_server }}"
      username: "{{ vcenter_user }}"
      password: "{{ vcenter_pass }}"
      validate_certs: no
      name: "{{ item }}-EDF-{{ vm_prefix }}{{ item.split('.')[-1][-3:] }}"
      template: "{{ mapr_template_name }}"
      datacenter: "{{ datacenter_name }}"
      folder: "{{vcenter_folder}}"
      cluster: "{{ cluster_name }}"
      datastore: "{{ vcenter_datastore }}"
      hardware:
        memory_mb: "{{ vm_mapr_memory }}"
        num_cpus: "{{ vm_mapr_cpu_cores }}"
      networks:
      - name: "{{ vcenter_vswitch }}"
        ip: "{{ item }}"
        netmask: "{{ vm_network | ansible.utils.ipaddr('netmask') }}"
        gateway: "{{ vm_gateway }}"
        type: static
        dns_servers: "{{ vm_dns }}"
      disk:
        - autoselect_datastore: no
          datastore: "{{ vcenter_datastore }}"
          size_gb: 400
          type: thin
        - autoselect_datastore: no
          datastore: "{{ vcenter_datastore }}"
          size_gb: "{{ vm_mapr_disk }}"
          type: thin
      customization:
        hostname: "{{ host_prefix }}{{ item.split('.')[-1][-3:] }}"
        domain: "{{ vm_domain }}"
        dns_servers: "{{ vm_dns }}"
      state: poweredon
      wait_for_ip_address: no
    delegate_to: localhost
    with_items: "{{ mapr_ips }}"

- hosts: all
  gather_facts: no
  tasks:
  - name: Wait 600 seconds for target connection to become reachable/usable
    wait_for_connection:
        
######################################################################################################
# VMWARE DEPLOYMENT END
######################################################################################################
